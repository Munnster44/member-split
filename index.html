<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Member Splitter v2.3.3-PWA (Excel-only Edition)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0b5cad" />
<link id="manifestLink" rel="manifest" href="#">
<style>
  :root{
    --brand:#0b5cad; --brand-600:#0a529c; --bg:#f6f8fb; --text:#111827; --muted:#6b7280;
    --ctrlbg:#eaf2fb; --ctrlline:#d9e6fb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header,footer{background:linear-gradient(180deg,var(--brand),var(--brand-600));color:#fff}
  header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  header h1{margin:0;font-size:1.35rem;font-weight:800;display:flex;align-items:center;gap:10px}
  header small{opacity:.95;font-weight:700}
  main{max-width:980px;margin:22px auto;padding:0 16px 96px}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:16px;border:1px solid #e5e7eb;margin-bottom:16px}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  select,input[type=file]{padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;background:#fff}
  .controls-bar{background:var(--ctrlbg);border:1px solid var(--ctrlline);padding:18px;border-radius:14px;margin-top:22px;margin-bottom:18px}
  .controls-row{display:flex;flex-wrap:wrap;justify-content:center;gap:18px 16px;align-items:center}
  .controls-row .btn{min-width:140px}
  .progress{font-size:.95rem;color:var(--muted)}
  #overlay{position:fixed;inset:0;background:rgba(255,255,255,.75);display:none;align-items:center;justify-content:center;z-index:50}
  .spinner{width:54px;height:54px;border:6px solid #e5e7eb;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .counts{margin-top:8px;font-size:.95rem;color:#1f2937}
  .counts .line{padding:4px 8px;border-radius:8px;background:#f9fafb;border:1px solid #eef2f7;margin:4px 0}
  .counts .subcounts{margin-left:20px;font-size:.9rem;color:#374151}
  #readmePanel{display:none;margin-top:12px;background:#eef2ff;border:1px solid #c7d2fe;padding:16px;border-radius:12px;font-size:.95rem;position:relative}
  #readmePanel h3{margin-top:0;color:#1e3a8a}
  .readme-close{position:absolute;top:8px;right:10px;border:1px solid #0b5cad;background:#fff;color:#0b5cad;border-radius:10px;padding:4px 8px;cursor:pointer;font-weight:700}
  footer{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;text-align:center;font-size:.9rem}
  #appIcon{width:50px;height:50px;border-radius:10px;display:inline-block}
  #swStatus{margin-top:8px;text-align:center;color:#374151}
</style>
<!-- GitHub-ready: start_url "./", scope "./" -->
</head>
<body>
<header>
  <h1>
    <canvas id="appIcon" width="50" height="50"></canvas>
    Member Splitter <small>v2.3.3-PWA (Excel-only Edition)</small>
  </h1>
</header>

<main>
  <div class="card">
    <!-- Controls -->
    <div class="controls-bar">
      <div class="controls-row">
        <input id="file" type="file" accept=".xlsx,.xls" />
        <select id="groupBy">
          <option value="District">District</option>
          <option value="Squadron">Squadron</option>
          <option value="DistrictSortedBySquadron">District (rows sorted by Squadron)</option>
        </select>
        <button id="build" class="btn" disabled>Generate workbook</button>
        <button id="save" class="btn" disabled>Save as…</button>
        <button id="toggleReadme" class="btn" type="button">View README</button>
        <span id="status" class="progress">Waiting…</span>
      </div>
    </div>

    <!-- SW status (icons only) -->
    <div id="swStatus">Service Worker: ❌</div>

    <!-- README (collapsed by default) -->
    <div id="readmePanel">
      <button class="readme-close" id="readmeCloseBtn">× Close</button>
      <h3>About This Tool</h3>
      <p><strong>Purpose:</strong> Organize membership data by <em>District</em> or <em>Squadron</em>. The app creates one worksheet per group and a first-tab <em>Summary</em> sheet with totals by membership type (Regular, Regular Life, Former Member, Non Member, Other).</p>
      <p><strong>Usage:</strong> 1) Load your .xlsx  2) Choose grouping (District / Squadron / District sorted by Squadron)  3) Click <em>Generate workbook</em>  4) Click <em>Save as…</em>.</p>
      <p><strong>Notes:</strong> Works completely offline after first open. “(Unspecified)” group is listed first; others sort A→Z. This build exports the Excel file only.</p>
      <p><strong>Support:</strong> ds-niagara@cps-ecp.ca — © 2025 CanBoat / NautiSavoir</p>
    </div>

    <!-- Counts + summary status -->
    <div id="counts" class="counts"></div>
    <div id="summary" class="progress">No data yet.</div>
  </div>
</main>

<footer>
  © 2025 CanBoat / NautiSavoir — Member Splitter v2.3.3-PWA (embedded) — Excel Output Only
</footer>

<div id="overlay"><div class="spinner" aria-label="Processing"></div></div>

<!-- Load SheetJS from local file in the same folder (then cache) -->
<script>
  (function loadSheetJS(){
    var s = document.createElement('script');
    s.src = './xlsx.full.min.js';   // <-- place this file next to index.html
    s.onload = function(){ console.log('SheetJS loaded'); };
    s.onerror = function(){ alert('Failed to load xlsx.full.min.js from the same folder.'); };
    document.head.appendChild(s);
  })();
</script>

<script>
// Draw 50×50 MS icon
(function(){
  try{
    var c=document.getElementById('appIcon'); var ctx=c.getContext('2d');
    ctx.fillStyle='#0b5cad'; ctx.fillRect(0,0,50,50);
    ctx.fillStyle='#fff'; ctx.font='bold 22px system-ui,Segoe UI,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('MS',25,28);
  }catch(e){}
})();

// Manifest (single-file technique) — GitHub-ready (start_url "./", scope "./")
(function(){
  var icon192='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAABm0m1iAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAUklEQVR4nO3NsQkAMAxFQf3/0yMo0o3Eo4B8w4m2Gx8gMS2kDa9u/3oAAAB8i3wMSU1MS0xNTExMTExMTExMTExMTExMTExMS0xNS8yICBNUyAtIGJsdWUAAADyKc5oXg1xT3QAAAAASUVORK5CYII=';
  var icon512='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAAHgCAYAAABYVxgXAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaElEQVR4nO3BMQEAAAgDINc/9B0hEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgK2mIAAQAAAPBXx3gAAeLxwAAAAABJRU5ErkJggg==';
  var manifest={
    name:'Member Splitter',
    short_name:'Member Splitter',
    start_url:'./',
    scope:'./',
    display:'standalone',
    background_color:'#0b5cad',
    theme_color:'#0b5cad',
    icons:[{src:icon192,sizes:'192x192',type:'image/png'},{src:icon512,sizes:'512x512',type:'image/png'}]
  };
  var url=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}));
  document.getElementById('manifestLink').setAttribute('href',url);
})();
</script>

<script>
// Service Worker — GitHub Pages–safe (scope "./")
(function(){
  if(!('serviceWorker' in navigator)) {
    var s=document.getElementById('swStatus'); if(s) s.textContent='Service Worker: ❌'; return;
  }
  var swCode = `
    const CACHE='member-splitter-v2.3.3';
    self.addEventListener('install',e=>{e.waitUntil(self.skipWaiting())});
    self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
    // Offline strategy: try network, then fall back to cache (minimal since single-file + local JS)
    self.addEventListener('fetch',e=>{
      e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));
    });
  `;
  var swUrl = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
  navigator.serviceWorker.register(swUrl,{scope:'./'})
    .then(()=> {
      var s=document.getElementById('swStatus'); if(s) s.textContent='Service Worker: ✅';
    })
    .catch(()=> {
      var s=document.getElementById('swStatus'); if(s) s.textContent='Service Worker: ❌';
    });
})();
</script>

<script>
// App logic
(function(){
  var fileInput=document.getElementById('file');
  var groupBySel=document.getElementById('groupBy');
  var buildBtn=document.getElementById('build');
  var saveBtn=document.getElementById('save');
  var statusEl=document.getElementById('status');
  var overlay=document.getElementById('overlay');
  var countsEl=document.getElementById('counts');
  var summaryEl=document.getElementById('summary');
  var toggleReadme=document.getElementById('toggleReadme');
  var readmePanel=document.getElementById('readmePanel');
  var readmeCloseBtn=document.getElementById('readmeCloseBtn');

  function showOverlay(on){ overlay.style.display=on?'flex':'none'; }
  function setStatus(msg){ statusEl.textContent=msg; }

  // README toggle + close
  if(toggleReadme && readmePanel){
    toggleReadme.onclick=function(){
      var open=readmePanel.style.display==='block';
      readmePanel.style.display=open?'none':'block';
      toggleReadme.textContent=open?'View README':'Hide README';
    };
  }
  if(readmeCloseBtn && toggleReadme){
    readmeCloseBtn.onclick=function(){
      readmePanel.style.display='none';
      toggleReadme.textContent='View README';
    };
  }

  // Wait for SheetJS to load before enabling build
  function waitForXLSX(cb){
    var tries=0;(function loop(){
      if(window.XLSX && XLSX.utils && XLSX.read){ cb(); return; }
      if(++tries>80){ alert('Excel engine failed to load. Ensure xlsx.full.min.js is next to index.html.'); return; }
      setTimeout(loop,120);
    })();
  }

  // Handle file selection
  fileInput.addEventListener('change',function(e){
    if(!fileInput.files || !fileInput.files[0]){ setStatus('Waiting…'); buildBtn.disabled=true; return; }
    waitForXLSX(async function(){
      showOverlay(true); setStatus('Reading workbook…');
      try{
        var f=fileInput.files[0];
        var data=await f.arrayBuffer();
        var wb=XLSX.read(data,{type:'array'});
        var ws=wb.Sheets[wb.SheetNames[0]];
        var rows=XLSX.utils.sheet_to_json(ws,{defval:''});
        window._rows=rows;
        setTimeout(function(){
          setStatus('Loaded '+rows.length+' rows from "'+wb.SheetNames[0]+'".'); showOverlay(false);
        },300);
        summaryEl.textContent=rows.length?'Ready to generate.':'No rows detected.';
        countsEl.innerHTML='';
        buildBtn.disabled = rows.length===0;
      }catch(err){
        console.error(err); alert('Failed to read Excel.'); setStatus('Error'); showOverlay(false);
      }
    });
  });

  function sanitizeSheetName(name){
    if(!name||!String(name).trim())return'(Unspecified)';
    var c=String(name).replace(/[:\\/?*\\[\\]]/g,' ').replace(/\\s+/g,' ').trim();
    return c.length>31?c.substring(0,31):c;
  }
  function groupBy(arr,key){
    var m=new Map();
    arr.forEach(function(r){
      var v=sanitizeSheetName(r[key]||'(Unspecified)');
      if(!m.has(v))m.set(v,[]);
      m.get(v).push(r);
    });
    return m;
  }
  function sortGroups(map){
    var arr=Array.from(map.entries());
    arr.sort(function(a,b){
      if(a[0]==='(Unspecified)')return-1;
      if(b[0]==='(Unspecified)')return 1;
      return a[0].localeCompare(b[0]);
    });
    return arr;
  }
  function sortRows(rows,key){
    return rows.slice().sort(function(a,b){
      var av=(a[key]||'').toString().toLowerCase(), bv=(b[key]||'').toString().toLowerCase();
      if(av==='(unspecified)'||av==='')return-1;
      if(bv==='(unspecified)'||bv==='')return 1;
      return av.localeCompare(bv);
    });
  }
  function normalizeType(s){
    var t=(s||'').toLowerCase().replace(/\\s+/g,' ').trim();
    if(t==='regular'||(t.indexOf('regular')===0 && t.indexOf('life')===-1))return'Regular';
    if(t.indexOf('life')!==-1)return'Regular Life';
    if(t.indexOf('former')!==-1)return'Former Member';
    if(t.indexOf('non')!==-1 && t.indexOf('member')!==-1)return'Non Member';
    return'Other';
  }
  function countMembershipTypes(rows){
    var b={'Regular':0,'Regular Life':0,'Former Member':0,'Non Member':0,'Other':0};
    for(var i=0;i<rows.length;i++){ b[normalizeType(rows[i]['Membership Type'])]++; }
    return b;
  }

  function buildWorkbook(){
    var rows=window._rows||[]; if(!rows.length){ alert('No data loaded'); return; }
    var mode=groupBySel.value; var key=(mode==='Squadron'?'Squadron':'District');
    var groups=groupBy(rows,key); groups=sortGroups(groups);
    var wb=XLSX.utils.book_new(); var html='<h4>Group counts</h4>';
    var summaryData=[]; var totals={'Regular':0,'Regular Life':0,'Former Member':0,'Non Member':0,'Other':0,'Total':0};

    groups.forEach(function(entry){
      var n=entry[0], rs=entry[1];
      var use=(mode==='DistrictSortedBySquadron')?sortRows(rs,'Squadron'):sortRows(rs,key);
      var ws=XLSX.utils.json_to_sheet(use); var c=use.length; var st=countMembershipTypes(use);
      Object.keys(totals).forEach(function(k){ if(k!=='Total') totals[k]+=st[k]; }); totals.Total+=c;

      var suff=' ('+c+')'; var base=n||'(Unspecified)';
      var avail=31 - suff.length; if(avail<1) avail=1;
      var trimmed=base.length>avail?base.slice(0,avail):base;
      var sheetName=trimmed+suff;
      XLSX.utils.book_append_sheet(wb,ws,sheetName);

      summaryData.push({Group:base,Total:c,'Regular':st['Regular'],'Regular Life':st['Regular Life'],'Former Member':st['Former Member'],'Non Member':st['Non Member'],'Other':st['Other']});
      html+= "<div class='line'><strong>"+key+":</strong> "+base+" — <strong>"+c+
             "</strong><div class='subcounts'>Regular: "+st['Regular']+" • Regular Life: "+st['Regular Life']+
             " • Former Member: "+st['Former Member']+" • Non Member: "+st['Non Member']+
             (st['Other']?" • Other: "+st['Other']:"")+"</div></div>";
    });

    var sumData=[['Total Members:',totals.Total],[],['Group','Total','Regular','Regular Life','Former Member','Non Member','Other']];
    summaryData.forEach(function(r){ sumData.push([r.Group,r.Total,r['Regular'],r['Regular Life'],r['Former Member'],r['Non Member'],r['Other']]); });
    sumData.push(['Totals',totals.Total,totals['Regular'],totals['Regular Life'],totals['Former Member'],totals['Non Member'],totals['Other']]);
    var wsSum=XLSX.utils.aoa_to_sheet(sumData);
    XLSX.utils.book_append_sheet(wb,wsSum,'Summary'); wb.SheetNames.unshift(wb.SheetNames.pop());

    window._wb=wb; countsEl.innerHTML=html; summaryEl.textContent="Created "+groups.length+" sheets grouped by "+key;
    saveBtn.disabled=false; setStatus('Ready to save.');
  }

  buildBtn.addEventListener('click', buildWorkbook);

  saveBtn.addEventListener('click', function(){
    if(!window._wb){ alert('Please generate the workbook first.'); return; }
    var mode=groupBySel.value||'District';
    var suffix=(mode==='DistrictSortedBySquadron')?'district_sorted_by_squadron':('by_'+mode.toLowerCase());
    var def='member_split_'+suffix+'.xlsx';
    var wbout=XLSX.write(window._wb,{bookType:'xlsx',type:'array'});
    var blob=new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=def; document.body.appendChild(a); a.click(); a.remove();
    setStatus('Downloaded Excel.');
  });
})();
</script>
</body>
</html>
